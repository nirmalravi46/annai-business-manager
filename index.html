<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idiyappam Billing Software</title>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffd;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-primary-active: #1a6873;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-secondary-hover: rgba(94, 82, 64, 0.2);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #21808d;
            --color-error: #c0152f;
            --color-btn-primary-text: #fcfcf9;
            --radius-base: 8px;
            --radius-lg: 12px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-primary-active: #2996a1;
                --color-secondary: rgba(119, 124, 124, 0.15);
                --color-secondary-hover: rgba(119, 124, 124, 0.25);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-success: #32b8c6;
                --color-error: #ff5459;
                --color-btn-primary-text: #134252;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: var(--space-20);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-24);
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-8);
        }

        .tabs {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-24);
            border-bottom: 1px solid var(--color-border);
        }

        .tab {
            padding: var(--space-12) var(--space-20);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: var(--font-size-base);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            margin-bottom: var(--space-20);
            border: 1px solid var(--color-border);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        input, select, textarea {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            background: var(--color-surface);
            color: var(--color-text);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: var(--space-12) var(--space-20);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .invoice-items {
            margin-bottom: var(--space-16);
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 50px;
            gap: var(--space-12);
            margin-bottom: var(--space-12);
            align-items: end;
        }

        .item-header {
            font-weight: 500;
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-8);
        }

        .btn-remove {
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: var(--radius-base);
            padding: var(--space-12);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }

        .totals {
            border-top: 2px solid var(--color-border);
            padding-top: var(--space-16);
            margin-top: var(--space-16);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-8);
        }

        .total-row.grand {
            font-weight: 600;
            font-size: var(--font-size-lg);
            color: var(--color-primary);
        }

        .invoice-preview {
            background: white;
            color: #000;
            padding: 40px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
        }

        .invoice-title {
            font-size: 28px;
            font-weight: bold;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .detail-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #666;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .invoice-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .invoice-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .invoice-table .text-right {
            text-align: right;
        }

        .invoice-totals {
            margin-left: auto;
            width: 300px;
        }

        .action-buttons {
            display: flex;
            gap: var(--space-12);
            margin-top: var(--space-20);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        th, td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            font-weight: 600;
            background: var(--color-secondary);
        }

        .status-paid {
            color: var(--color-success);
            font-weight: 500;
        }

        .status-pending {
            color: var(--color-error);
            font-weight: 500;
        }

        @media print {
            body {
                background: white;
            }
            .tabs, .action-buttons, .btn {
                display: none !important;
            }
            .invoice-preview {
                border: none;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .item-row {
                grid-template-columns: 1fr;
            }
            .invoice-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçú Idiyappam Billing Software</h1>
            <p style="color: var(--color-text-secondary);">Complete billing solution for your idiyappam business</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('invoice')">Create Invoice</button>
            <button class="tab" onclick="showTab('history')">Invoice History</button>
            <button class="tab" onclick="showTab('customers')">Customers</button>
            <button class="tab" onclick="showTab('reports')">Reports</button>
        </div>

        <div id="invoice-tab" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: var(--space-20);">New Invoice</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-20); margin-bottom: var(--space-20);">
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="invoiceNumber" value="INV-001" readonly>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date</label>
                        <input type="date" id="invoiceDate">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-20); margin-bottom: var(--space-20);">
                    <div>
                        <h3 style="margin-bottom: var(--space-12);">Your Business Details</h3>
                        <div class="form-group">
                            <label>Company Logo (Optional)</label>
                            <input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)" style="margin-bottom: var(--space-8);">
                            <div id="logoPreview" style="margin-top: var(--space-8); display: none;">
                                <img id="logoImage" style="max-width: 150px; max-height: 80px; border-radius: var(--radius-base); border: 1px solid var(--color-border);">
                                <button type="button" class="btn-remove" onclick="removeLogo()" style="margin-left: var(--space-8); padding: 4px 8px;">Remove</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Business Name</label>
                            <input type="text" id="businessName" value="Sri Lakshmi Idiyappam">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="businessAddress">123 Main Street, Salem, Tamil Nadu - 636001</textarea>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="businessPhone" value="9876543210">
                        </div>
                        <div class="form-group">
                            <label>GSTIN (Optional)</label>
                            <input type="text" id="businessGST" placeholder="33XXXXX1234X1ZX">
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: var(--space-12);">Customer Details</h3>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="customerName" list="customer-list">
                            <datalist id="customer-list"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="customerAddress"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="customerPhone">
                        </div>
                        <div class="form-group">
                            <label>GSTIN (Optional)</label>
                            <input type="text" id="customerGST" placeholder="Leave blank if not registered">
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: var(--space-12);">Invoice Items</h3>
                <div class="invoice-items">
                    <div class="item-row item-header">
                        <div>Item Description</div>
                        <div>Quantity</div>
                        <div>Rate (‚Çπ)</div>
                        <div>Amount (‚Çπ)</div>
                        <div></div>
                    </div>
                    <div id="items-container">
                        <div class="item-row">
                            <input type="text" placeholder="e.g., Idiyappam (Plain)" value="Idiyappam (Plain)" class="item-desc">
                            <input type="number" placeholder="100" value="100" min="1" class="item-qty">
                            <input type="number" placeholder="3.50" value="3.50" min="0" step="0.01" class="item-rate">
                            <input type="number" value="350.00" readonly class="item-amount">
                            <button class="btn-remove" onclick="removeItem(this)">√ó</button>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="addItem()">+ Add Item</button>

                <div class="totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">‚Çπ350.00</span>
                    </div>
                    <div class="form-group" style="max-width: 300px; margin-left: auto;">
                        <label>Discount (%)</label>
                        <input type="number" id="discount" value="0" min="0" max="100" step="0.01" onchange="calculateTotals()">
                    </div>
                    <div class="total-row">
                        <span>Discount Amount:</span>
                        <span id="discountAmount">‚Çπ0.00</span>
                    </div>
                    <div class="form-group" style="max-width: 300px; margin-left: auto;">
                        <label>GST (%)</label>
                        <input type="number" id="gst" value="0" min="0" max="28" step="0.01" onchange="calculateTotals()">
                    </div>
                    <div class="total-row">
                        <span>GST Amount:</span>
                        <span id="gstAmount">‚Çπ0.00</span>
                    </div>
                    <div class="total-row grand">
                        <span>Grand Total:</span>
                        <span id="grandTotal">‚Çπ350.00</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="generateInvoice()">Generate Invoice</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>
            </div>

            <div id="invoice-display" style="display: none;">
                <div class="card">
                    <div class="invoice-preview" id="invoice-content">
                        <!-- Invoice will be generated here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="window.print()">Print Invoice</button>
                        <button class="btn btn-secondary" onclick="saveInvoice()">Save Invoice</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('invoice-display').style.display='none'">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: var(--space-20);">Invoice History</h2>
                <div class="table-container">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--color-text-secondary);">No invoices yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="customers-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: var(--space-20);">Customer List</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Total Invoices</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody id="customers-body">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--color-text-secondary);">No customers yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reports-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: var(--space-20);">Business Reports</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-20); margin-bottom: var(--space-24);">
                    <div style="background: var(--color-secondary); padding: var(--space-20); border-radius: var(--radius-base);">
                        <h3 style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Total Sales</h3>
                        <p style="font-size: var(--font-size-2xl); font-weight: 600;" id="total-sales">‚Çπ0.00</p>
                    </div>
                    <div style="background: var(--color-secondary); padding: var(--space-20); border-radius: var(--radius-base);">
                        <h3 style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Total Invoices</h3>
                        <p style="font-size: var(--font-size-2xl); font-weight: 600;" id="total-invoices">0</p>
                    </div>
                    <div style="background: var(--color-secondary); padding: var(--space-20); border-radius: var(--radius-base);">
                        <h3 style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Total Customers</h3>
                        <p style="font-size: var(--font-size-2xl); font-weight: 600;" id="total-customers">0</p>
                    </div>
                    <div style="background: var(--color-secondary); padding: var(--space-20); border-radius: var(--radius-base);">
                        <h3 style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Average Invoice</h3>
                        <p style="font-size: var(--font-size-2xl); font-weight: 600;" id="avg-invoice">‚Çπ0.00</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let invoices = [];
        let customers = {};
        let invoiceCounter = 1;

        // Set today's date
        document.getElementById('invoiceDate').valueAsDate = new Date();

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') updateHistory();
            if (tabName === 'customers') updateCustomers();
            if (tabName === 'reports') updateReports();
        }

        // Add new item row
        function addItem() {
            const container = document.getElementById('items-container');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <input type="text" placeholder="Item description" class="item-desc">
                <input type="number" placeholder="Qty" value="1" min="1" class="item-qty">
                <input type="number" placeholder="Rate" value="0" min="0" step="0.01" class="item-rate">
                <input type="number" value="0" readonly class="item-amount">
                <button class="btn-remove" onclick="removeItem(this)">√ó</button>
            `;
            container.appendChild(newRow);
            attachItemListeners(newRow);
        }

        // Remove item row
        function removeItem(btn) {
            btn.parentElement.remove();
            calculateTotals();
        }

        // Calculate item amount
        function attachItemListeners(row) {
            const qty = row.querySelector('.item-qty');
            const rate = row.querySelector('.item-rate');
            const amount = row.querySelector('.item-amount');

            function updateAmount() {
                const total = (parseFloat(qty.value) || 0) * (parseFloat(rate.value) || 0);
                amount.value = total.toFixed(2);
                calculateTotals();
            }

            qty.addEventListener('input', updateAmount);
            rate.addEventListener('input', updateAmount);
        }

        // Attach listeners to initial item
        document.querySelectorAll('.item-row').forEach(row => attachItemListeners(row));

        // Calculate totals
        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-amount').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });

            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const discountAmount = (subtotal * discount) / 100;
            const afterDiscount = subtotal - discountAmount;

            const gst = parseFloat(document.getElementById('gst').value) || 0;
            const gstAmount = (afterDiscount * gst) / 100;
            const grandTotal = afterDiscount + gstAmount;

            document.getElementById('subtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `‚Çπ${discountAmount.toFixed(2)}`;
            document.getElementById('gstAmount').textContent = `‚Çπ${gstAmount.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
        }

        // Generate invoice preview
        function generateInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const businessName = document.getElementById('businessName').value;
            const businessAddress = document.getElementById('businessAddress').value;
            const businessPhone = document.getElementById('businessPhone').value;
            const businessGST = document.getElementById('businessGST').value;
            const customerName = document.getElementById('customerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerGST = document.getElementById('customerGST').value;

            if (!customerName) {
                alert('Please enter customer name');
                return;
            }

            let itemsHTML = '';
            const items = [];
            document.querySelectorAll('.item-row').forEach((row, index) => {
                if (index === 0) return; // Skip header
                const desc = row.querySelector('.item-desc').value;
                const qty = row.querySelector('.item-qty').value;
                const rate = row.querySelector('.item-rate').value;
                const amount = row.querySelector('.item-amount').value;

                if (desc && qty && rate) {
                    items.push({ desc, qty, rate, amount });
                    itemsHTML += `
                        <tr>
                            <td>${items.length}</td>
                            <td>${desc}</td>
                            <td class="text-right">${qty}</td>
                            <td class="text-right">‚Çπ${parseFloat(rate).toFixed(2)}</td>
                            <td class="text-right">‚Çπ${parseFloat(amount).toFixed(2)}</td>
                        </tr>
                    `;
                }
            });

            const subtotal = document.getElementById('subtotal').textContent;
            const discountAmount = document.getElementById('discountAmount').textContent;
            const gstAmount = document.getElementById('gstAmount').textContent;
            const grandTotal = document.getElementById('grandTotal').textContent;

            const logoData = localStorage.getItem('companyLogo');
            
            const invoiceHTML = `
                <div class="invoice-header">
                    <div>
                        ${logoData ? `<img src="${logoData}" style="max-width: 120px; max-height: 60px; margin-bottom: 10px;">` : ''}
                        <div class="invoice-title">${businessName}</div>
                        <p style="margin: 5px 0;">${businessAddress}</p>
                        <p style="margin: 5px 0;">Phone: ${businessPhone}</p>
                        ${businessGST ? `<p style="margin: 5px 0;">GSTIN: ${businessGST}</p>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="invoice-title">TAX INVOICE</div>
                        <p style="margin: 10px 0;"><strong>Invoice #:</strong> ${invoiceNumber}</p>
                        <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(invoiceDate).toLocaleDateString('en-IN')}</p>
                    </div>
                </div>

                <div class="invoice-details">
                    <div class="detail-section">
                        <h3>BILL TO:</h3>
                        <p style="font-weight: 600; margin-bottom: 5px;">${customerName}</p>
                        <p style="margin: 3px 0;">${customerAddress}</p>
                        <p style="margin: 3px 0;">Phone: ${customerPhone}</p>
                        ${customerGST ? `<p style="margin: 3px 0;">GSTIN: ${customerGST}</p>` : ''}
                    </div>
                    <div class="detail-section">
                        <h3>PAYMENT TERMS:</h3>
                        <p>Payment Due: On Receipt</p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Description</th>
                            <th class="text-right" style="width: 100px;">Quantity</th>
                            <th class="text-right" style="width: 120px;">Rate</th>
                            <th class="text-right" style="width: 120px;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>

                <div class="invoice-totals">
                    <table style="width: 100%; font-size: 14px;">
                        <tr>
                            <td style="padding: 8px 0; border: none;">Subtotal:</td>
                            <td style="padding: 8px 0; text-align: right; border: none;">${subtotal}</td>
                        </tr>
                        ${discountAmount !== '‚Çπ0.00' ? `
                        <tr>
                            <td style="padding: 8px 0; border: none;">Discount:</td>
                            <td style="padding: 8px 0; text-align: right; border: none;">-${discountAmount}</td>
                        </tr>
                        ` : ''}
                        ${gstAmount !== '‚Çπ0.00' ? `
                        <tr>
                            <td style="padding: 8px 0; border: none;">GST:</td>
                            <td style="padding: 8px 0; text-align: right; border: none;">${gstAmount}</td>
                        </tr>
                        ` : ''}
                        <tr style="border-top: 2px solid #000;">
                            <td style="padding: 12px 0; font-size: 18px; font-weight: bold; border: none;">Grand Total:</td>
                            <td style="padding: 12px 0; font-size: 18px; font-weight: bold; text-align: right; border: none;">${grandTotal}</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                    <p><strong>Terms & Conditions:</strong></p>
                    <p>1. Payment is due upon receipt of invoice.</p>
                    <p>2. All products are made fresh and should be consumed within 24 hours.</p>
                    <p>3. Thank you for your business!</p>
                </div>

                <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #999;">
                    <p>Generated by Idiyappam Billing Software</p>
                </div>
            `;

            document.getElementById('invoice-content').innerHTML = invoiceHTML;
            document.getElementById('invoice-display').style.display = 'block';
            document.getElementById('invoice-display').scrollIntoView({ behavior: 'smooth' });
        }

        // Save invoice
        function saveInvoice() {
            const invoice = {
                number: document.getElementById('invoiceNumber').value,
                date: document.getElementById('invoiceDate').value,
                customer: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                amount: document.getElementById('grandTotal').textContent,
                status: 'Paid',
                items: []
            };

            document.querySelectorAll('.item-row').forEach((row, index) => {
                if (index === 0) return;
                const desc = row.querySelector('.item-desc')?.value;
                if (desc) {
                    invoice.items.push({
                        description: desc,
                        quantity: row.querySelector('.item-qty').value,
                        rate: row.querySelector('.item-rate').value,
                        amount: row.querySelector('.item-amount').value
                    });
                }
            });

            invoices.push(invoice);

            // Update customer data
            if (!customers[invoice.customer]) {
                customers[invoice.customer] = {
                    name: invoice.customer,
                    phone: invoice.customerPhone,
                    invoiceCount: 0,
                    totalAmount: 0
                };
            }
            customers[invoice.customer].invoiceCount++;
            customers[invoice.customer].totalAmount += parseFloat(invoice.amount.replace('‚Çπ', ''));

            // Update customer list in datalist
            updateCustomerList();

            alert('Invoice saved successfully!');
            
            // Increment invoice number
            invoiceCounter++;
            document.getElementById('invoiceNumber').value = `INV-${String(invoiceCounter).padStart(3, '0')}`;
            
            clearForm();
            document.getElementById('invoice-display').style.display = 'none';
        }

        // Update customer list
        function updateCustomerList() {
            const datalist = document.getElementById('customer-list');
            datalist.innerHTML = '';
            Object.values(customers).forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.name;
                datalist.appendChild(option);
            });
        }

        // Clear form
        function clearForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerGST').value = '';
            document.getElementById('discount').value = '0';
            document.getElementById('gst').value = '0';
            
            const container = document.getElementById('items-container');
            container.innerHTML = `
                <div class="item-row">
                    <input type="text" placeholder="e.g., Idiyappam (Plain)" value="Idiyappam (Plain)" class="item-desc">
                    <input type="number" placeholder="100" value="100" min="1" class="item-qty">
                    <input type="number" placeholder="3.50" value="3.50" min="0" step="0.01" class="item-rate">
                    <input type="number" value="350.00" readonly class="item-amount">
                    <button class="btn-remove" onclick="removeItem(this)">√ó</button>
                </div>
            `;
            document.querySelectorAll('.item-row').forEach(row => attachItemListeners(row));
            calculateTotals();
        }

        // Update invoice history
        function updateHistory() {
            const tbody = document.getElementById('history-body');
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-text-secondary);">No invoices yet</td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(inv => `
                <tr>
                    <td>${inv.number}</td>
                    <td>${new Date(inv.date).toLocaleDateString('en-IN')}</td>
                    <td>${inv.customer}</td>
                    <td>${inv.amount}</td>
                    <td class="status-${inv.status.toLowerCase()}">${inv.status}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="viewInvoice('${inv.number}')">View</button>
                    </td>
                </tr>
            `).reverse().join('');
        }

        // Update customers list
        function updateCustomers() {
            const tbody = document.getElementById('customers-body');
            const customerList = Object.values(customers);
            
            if (customerList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--color-text-secondary);">No customers yet</td></tr>';
                return;
            }

            tbody.innerHTML = customerList.map(cust => `
                <tr>
                    <td>${cust.name}</td>
                    <td>${cust.phone}</td>
                    <td>${cust.invoiceCount}</td>
                    <td>‚Çπ${cust.totalAmount.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Update reports
        function updateReports() {
            const totalSales = invoices.reduce((sum, inv) => sum + parseFloat(inv.amount.replace('‚Çπ', '')), 0);
            const avgInvoice = invoices.length > 0 ? totalSales / invoices.length : 0;

            document.getElementById('total-sales').textContent = `‚Çπ${totalSales.toFixed(2)}`;
            document.getElementById('total-invoices').textContent = invoices.length;
            document.getElementById('total-customers').textContent = Object.keys(customers).length;
            document.getElementById('avg-invoice').textContent = `‚Çπ${avgInvoice.toFixed(2)}`;
        }

        // Handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoData = e.target.result;
                    localStorage.setItem('companyLogo', logoData);
                    displayLogoPreview(logoData);
                };
                reader.readAsDataURL(file);
            }
        }

        // Display logo preview
        function displayLogoPreview(logoData) {
            document.getElementById('logoImage').src = logoData;
            document.getElementById('logoPreview').style.display = 'block';
        }

        // Remove logo
        function removeLogo() {
            localStorage.removeItem('companyLogo');
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('logoUpload').value = '';
        }

        // Load logo on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedLogo = localStorage.getItem('companyLogo');
            if (savedLogo) {
                displayLogoPreview(savedLogo);
            }
        });

        // View invoice from history
        function viewInvoice(invoiceNumber) {
            alert('Feature coming soon: View saved invoice #' + invoiceNumber);
        }
    </script>
</body>
</html>
